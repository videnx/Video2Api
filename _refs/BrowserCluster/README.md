# Browser Cluster

> [!IMPORTANT]
> **å‰æœŸé¡¹ç›®ä¼šæœ‰è¾ƒå¤š bugï¼Œè¯·å¤§å®¶è¸Šè·ƒæ issuesï¼Œä½œè€…çœ‹åˆ°åç¬¬ä¸€æ—¶é—´æ›´æ–°ï¼**

**Browser Cluster** æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€åˆ†å¸ƒå¼çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–é›†ç¾¤ç³»ç»Ÿï¼ŒåŸºäº **Playwright** å’Œ **DrissionPage** åŒæµè§ˆå™¨å¼•æ“ä»¥åŠ FastAPI æ„å»ºã€‚å®ƒæ”¯æŒå¤§è§„æ¨¡å¹¶å‘ç½‘é¡µæŠ“å–ã€æˆªå›¾ã€è§£æåŠè‡ªåŠ¨åŒ–æ“ä½œï¼Œç‰¹åˆ«é’ˆå¯¹ Cloudflare ç­‰é«˜éš¾åº¦åçˆ¬ç½‘ç«™è¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–ï¼Œå…·å¤‡å®Œå–„çš„ä»»åŠ¡è°ƒåº¦ã€ç»“æœç¼“å­˜å’ŒèŠ‚ç‚¹ç®¡ç†åŠŸèƒ½ã€‚

![UI Preview](admin/public/image.png)

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **åŒæµè§ˆå™¨å¼•æ“æ”¯æŒ**ï¼šæ”¯æŒ Playwright å’Œ DrissionPage åŒå¼•æ“åˆ‡æ¢ã€‚
    - **Playwright**ï¼šé€‚ç”¨äºå¤æ‚çš„è‡ªåŠ¨åŒ–äº¤äº’å’Œ API æ‹¦æˆªåœºæ™¯ã€‚
    - **DrissionPage**ï¼šåŸç”ŸæŠ—æ£€æµ‹èƒ½åŠ›å¼ºï¼Œå¯è½»æ¾ç»•è¿‡ Cloudflare 5ç§’ç›¾åŠå„ç±»äººæœºéªŒè¯ã€‚
- **åˆ†å¸ƒå¼æ¶æ„**ï¼šæ”¯æŒå¤š Worker èŠ‚ç‚¹æ°´å¹³æ‰©å±•ï¼Œè½»æ¾åº”å¯¹é«˜å¹¶å‘åœºæ™¯ã€‚
- **éšèº«ä¸åæ£€æµ‹**ï¼š
    - Playwright å†…ç½® Stealth æ’ä»¶ã€‚
    - DrissionPage é‡‡ç”¨æµè§ˆå™¨æŒ‡çº¹æŠ¹é™¤æŠ€æœ¯ï¼Œæ”¯æŒ Linux ç¯å¢ƒæ·±åº¦éšè—ã€‚
- **é«˜æ•ˆç¼“å­˜**ï¼šåŸºäº Redis çš„ç»“æœç¼“å­˜æœºåˆ¶ï¼Œæ”¯æŒè‡ªå®šä¹‰ TTLã€‚
- **èµ„æºä¼˜åŒ–**ï¼šæ™ºèƒ½æ‹¦æˆªå›¾ç‰‡ã€åª’ä½“èµ„æºï¼Œæ˜¾è‘—æå‡æ¸²æŸ“é€Ÿåº¦ã€‚
- **API æ‹¦æˆª**ï¼šæ”¯æŒåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­æå–ç‰¹å®š XHR/Fetch æ¥å£æ•°æ®ã€‚
- **OSS äº‘å­˜å‚¨æ”¯æŒ**ï¼š
    - æ”¯æŒå°†æŠ“å–çš„ HTML æºç å’Œé¡µé¢æˆªå›¾è‡ªåŠ¨ä¸Šä¼ è‡³é˜¿é‡Œäº‘ OSSã€‚
    - è§£å†³å¤§è§„æ¨¡æ•°æ®å­˜å‚¨å‹åŠ›ï¼Œæ”¯æŒç§æœ‰æ¡¶å®‰å…¨è®¿é—®ã€‚
    - åç«¯è‡ªåŠ¨ä»£ç† OSS å†…å®¹ï¼Œè§£å†³å‰ç«¯ç›´æ¥è®¿é—®çš„è·¨åŸŸåŠæƒé™é—®é¢˜ã€‚
- **è‡ªåŠ¨åŒ–è°ƒåº¦**ï¼šå†…ç½®å®šæ—¶ä»»åŠ¡å¼•æ“ï¼Œæ”¯æŒ Interval å’Œ Cron è¡¨è¾¾å¼ï¼Œå®ç°å‘¨æœŸæ€§æ•°æ®é‡‡é›†ã€‚
- **å¤šæ¨¡å¼è§£ææå–**ï¼šé›†æˆå¤šç§ç»“æ„åŒ–æ•°æ®æå–æŠ€æœ¯ï¼Œé€‚é…ä¸åŒå¤æ‚åº¦çš„ç½‘é¡µï¼š
    - **æ™ºèƒ½é€šç”¨è§£æ (GNE)**ï¼šåŸºäºæ­£æ–‡æŠ½å–ç®—æ³•ï¼Œæ”¯æŒä¸¤ç§æå–æ¨¡å¼ï¼š
        - **è¯¦æƒ…æ¨¡å¼ (Detail)**ï¼šè‡ªåŠ¨æå–æ–°é—»ç±»ç½‘ç«™çš„æ ‡é¢˜ã€æ­£æ–‡ã€å‘å¸ƒæ—¶é—´åŠä½œè€…ã€‚
        - **åˆ—è¡¨æ¨¡å¼ (List)**ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶æå–æ–°é—»åˆ—è¡¨é¡µä¸­çš„æ ‡é¢˜ã€é“¾æ¥åŠå‘å¸ƒæ—¥æœŸã€‚
    - **ç²¾å‡†è§„åˆ™è§£æ (XPath/CSS)**ï¼šæ”¯æŒå¯è§†åŒ–é…ç½® XPath å’Œ CSS é€‰æ‹©å™¨ï¼Œé’ˆå¯¹ç”µå•†ã€åˆ—è¡¨é¡µç­‰ç»“æ„åŒ–é¡µé¢å®ç°åƒç´ çº§ç²¾å‡†æå–ã€‚
    - **å¤§æ¨¡å‹æ™ºèƒ½è§£æ (LLM)**ï¼šç»“åˆ OpenAI/DeepSeek ç­‰å¤§è¯­è¨€æ¨¡å‹ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€æè¿°æ‰€éœ€å­—æ®µï¼Œé›¶ä»£ç å®ç°å¤æ‚ç½‘é¡µçš„è¯­ä¹‰åŒ–æå–ã€‚
- **å¯è§†åŒ–ç®¡ç†**ï¼šæä¾›åŸºäº Vue 3 + Element Plus çš„ç°ä»£åŒ–ç®¡ç†åå°ã€‚
## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **åç«¯**ï¼šPython 3.10, FastAPI, Playwright, RabbitMQ, MongoDB, Redis
- **å‰ç«¯**ï¼šVue 3, Element Plus, Pinia, Vite
- **éƒ¨ç½²**ï¼šDocker (Multi-stage build)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

![Architecture](admin/public/architecture.png)

### ğŸ”„ ä»»åŠ¡å¤„ç†æµç¨‹

1. **è¯·æ±‚æ¥å…¥ä¸æ ¡éªŒ (Entry)**
   - `API Gateway` æ¥æ”¶ HTTP è¯·æ±‚ï¼Œæ‰§è¡Œ **JWT é‰´æƒ**ä¸å‚æ•°åˆæ³•æ€§æ ¡éªŒã€‚
   - `Task Scheduler` å®šæœŸè§¦å‘é¢„è®¾ä»»åŠ¡ï¼Œç›´æ¥è·³è¿‡ç½‘å…³é‰´æƒè¿›å…¥åˆ†å‘æµç¨‹ã€‚
   - æ£€æŸ¥ **Redis ç¼“å­˜**ï¼šè‹¥å‘½ä¸­ç¼“å­˜ä¸”æœªè¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›ç»“æœï¼Œè·³è¿‡åç»­æ­¥éª¤ã€‚

2. **ä»»åŠ¡æŒä¹…åŒ–ä¸åˆ†å‘ (Dispatch)**
   - API ç”Ÿæˆå…¨å±€å”¯ä¸€ `task_id`ï¼Œå¹¶åœ¨ **MongoDB** ä¸­åˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€ï¼ˆpendingï¼‰ã€‚
   - å°†ä»»åŠ¡è½½è·å‘å¸ƒè‡³ **RabbitMQ** ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå®ç°æµé‡å‰Šå³°ã€‚
   - åŒæ­¥æ¥å£è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œå¼‚æ­¥æ¥å£ç«‹å³è¿”å› `task_id`ã€‚

3. **æ™ºèƒ½è°ƒåº¦ä¸æ‰§è¡Œ (Execution)**
   - é—²ç½® `Worker` èŠ‚ç‚¹ç›‘å¬é˜Ÿåˆ—ï¼Œæ ¹æ®**ä»»åŠ¡ä¼˜å…ˆçº§**ç«äº‰è·å–ä»»åŠ¡ã€‚
   - Worker è°ƒç”¨ **Browser Manager** åˆ†é…ç‹¬ç«‹æµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼š
     - **ç¯å¢ƒæ¨¡æ‹Ÿ**ï¼šæ³¨å…¥ Stealth è„šæœ¬ã€é…ç½®ä»£ç†ã€æ¨¡æ‹ŸæŒ‡çº¹ä¸è§†å£ã€‚
     - **èµ„æºæ‹¦æˆª**ï¼šæ ¹æ®é…ç½®æ‹¦æˆªå›¾ç‰‡/åª’ä½“ï¼ŒåŠ é€Ÿæ¸²æŸ“ã€‚
     - **å®æ—¶æ‹¦æˆª**ï¼šæ³¨å†Œ API æ‹¦æˆªç›‘å¬å™¨ï¼Œæ•è· XHR/Fetch æ•°æ®ã€‚

4. **å¤šæ¨¡å¼è§£æ (Parsing)**
   - é¡µé¢åŠ è½½å®Œæˆåï¼ˆæ ¹æ® `wait_for` ç­–ç•¥ï¼‰ï¼ŒWorker è·å–æ¸²æŸ“åçš„ DOMã€‚
   - æ ¹æ® `parser` é…ç½®æ‰§è¡Œè§£æå¼•æ“ï¼š
     - **GNE**ï¼šè‡ªåŠ¨æå–æ­£æ–‡ä¸å…ƒæ•°æ®ã€‚
     - **XPath/CSS**ï¼šæŒ‰è§„åˆ™æ‰§è¡Œç²¾å‡†æå–ã€‚
     - **LLM**ï¼šè°ƒç”¨å¤§æ¨¡å‹è¿›è¡Œè¯­ä¹‰åŒ–å­—æ®µæ˜ å°„ã€‚

5. **ç»“æœå½’æ¡£ä¸åé¦ˆ (Feedback)**
   - **æˆåŠŸå¤„ç†**ï¼šå°† HTMLã€ç»“æ„åŒ–æ•°æ®ã€æˆªå›¾åŠæ€§èƒ½æŒ‡æ ‡å†™å…¥ MongoDBã€‚
   - **ç¼“å­˜æ›´æ–°**ï¼šå°†ç»“æœåŒæ­¥è‡³ Redisï¼ˆå¸¦ TTLï¼‰ï¼ŒåŠ é€Ÿåç»­ç›¸åŒè¯·æ±‚ã€‚
   - **å¼‚å¸¸å¤„ç†**ï¼šè‹¥æ‰§è¡Œå¤±è´¥ï¼Œè®°å½•é”™è¯¯å †æ ˆå¹¶è§¦å‘**é‡è¯•æœºåˆ¶**ï¼ˆå¯é€‰ï¼‰ã€‚
   - **ç»Ÿè®¡æ›´æ–°**ï¼šå®æ—¶ä¸ŠæŠ¥ä»»åŠ¡çŠ¶æ€ï¼Œæ›´æ–° **Prometheus/Stats** ç›‘æ§æ•°æ®ã€‚

### æ ¸å¿ƒç»„ä»¶

- **ğŸŒ API Gateway (FastAPI)**
  - ç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œè´Ÿè´£æ¥æ”¶ HTTP è¯·æ±‚ã€å‚æ•°æ ¡éªŒå’Œä»»åŠ¡è°ƒåº¦ã€‚
  - é›†æˆ Redis ç¼“å­˜å±‚ï¼Œå¯¹é‡å¤è¯·æ±‚ç›´æ¥è¿”å›ç¼“å­˜ç»“æœï¼Œæ˜¾è‘—é™ä½ç³»ç»Ÿè´Ÿè½½ã€‚
  - æä¾›å®Œæ•´çš„ä»»åŠ¡ç®¡ç†ã€èŠ‚ç‚¹ç›‘æ§å’Œç³»ç»Ÿé…ç½® APIã€‚

- **â° Task Scheduler (APScheduler)**
  - å†…ç½®é«˜æ€§èƒ½ä»»åŠ¡è°ƒåº¦å¼•æ“ï¼Œæ”¯æŒå¤§è§„æ¨¡å®šæ—¶ä»»åŠ¡å¹¶å‘ã€‚
  - æ”¯æŒä»»åŠ¡çŠ¶æ€å®æ—¶æ§åˆ¶ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰ã€æ‰‹åŠ¨å³æ—¶è§¦å‘å’Œæ‰§è¡Œå†å²è¿½è¸ªã€‚
  - æä¾› Interval (é—´éš”) å’Œ Cron (è¡¨è¾¾å¼) ä¸¤ç§çµæ´»çš„è°ƒåº¦ç­–ç•¥ã€‚

- **ğŸ“¨ Message Queue (RabbitMQ)**
  - å¼‚æ­¥ä»»åŠ¡æ€»çº¿ï¼Œå®ç°ç”Ÿäº§è€…ï¼ˆAPIï¼‰ä¸æ¶ˆè´¹è€…ï¼ˆWorkerï¼‰çš„å®Œå…¨è§£è€¦ã€‚
  - æ”¯æŒä»»åŠ¡æŒä¹…åŒ–ã€ä¼˜å…ˆçº§é˜Ÿåˆ—å’Œ ACK ç¡®è®¤æœºåˆ¶ï¼Œç¡®ä¿é«˜å¹¶å‘ä¸‹çš„ä»»åŠ¡å¯é æ€§ã€‚

- **ğŸ¤– Worker Nodes (Playwright & DrissionPage)**
  - åˆ†å¸ƒå¼æ‰§è¡Œå•å…ƒï¼Œæ”¯æŒå®¹å™¨åŒ–éƒ¨ç½²å’Œæ°´å¹³æ‰©å±•ã€‚
  - è´Ÿè´£å¯åŠ¨æµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œé¡µé¢æ¸²æŸ“ã€äº¤äº’ã€æˆªå›¾å’Œæ•°æ®æå–ã€‚
  - **åŒå¼•æ“é©±åŠ¨**ï¼šæ ¹æ®ä»»åŠ¡å‚æ•°åŠ¨æ€é€‰æ‹© Playwright æˆ– DrissionPageã€‚
  - **å•ä¾‹æ¨¡å¼ä¼˜åŒ–**ï¼šæµè§ˆå™¨å®ä¾‹å¸¸é©»å¤ç”¨ï¼Œé€šè¿‡æ ‡ç­¾é¡µç®¡ç†ä»»åŠ¡ï¼Œæå¤§é™ä½èµ„æºå¼€é”€å’Œå¯åŠ¨å»¶è¿Ÿã€‚
  - å†…ç½® **Stealth Mode** å’Œèµ„æºæ‹¦æˆªç­–ç•¥ï¼Œä¼˜åŒ–æŠ“å–æˆåŠŸç‡å’Œé€Ÿåº¦ã€‚

- **ğŸ’¾ Data Storage**
  - **MongoDB**: å­˜å‚¨å…¨é‡ä»»åŠ¡è®°å½•ã€æŠ“å–ç»“æœã€èŠ‚ç‚¹çŠ¶æ€å’Œç³»ç»Ÿé…ç½®ã€‚
  - **Redis**: ç”¨äºçƒ­ç‚¹æ•°æ®ç¼“å­˜å’Œåˆ†å¸ƒå¼é”ï¼Œæå‡ç³»ç»Ÿå“åº”é€Ÿåº¦ã€‚

- **ğŸ–¥ï¸ Admin Dashboard (Vue 3)**
  - **ç»Ÿè®¡ç›‘æ§**ï¼šå®æ—¶å±•ç¤ºä»»åŠ¡æˆåŠŸç‡ã€å¤„ç†æ—¶é•¿åŠé˜Ÿåˆ—å †ç§¯æƒ…å†µã€‚
  - **ä»»åŠ¡ç®¡ç†**ï¼šå…¨é‡ä»»åŠ¡å†å²æº¯æºï¼Œæ”¯æŒç»“æœé¢„è§ˆåŠé”™è¯¯æ—¥å¿—æŸ¥çœ‹ã€‚
  - **èŠ‚ç‚¹ç®¡ç†**ï¼šç›‘æ§é›†ç¾¤ Worker çŠ¶æ€ã€è´Ÿè½½æƒ…å†µåŠèµ„æºå ç”¨ï¼Œæ”¯æŒèŠ‚ç‚¹ä¸Šä¸‹çº¿ç®¡ç†ã€‚
  - **è§£æè§„åˆ™**ï¼šå¯è§†åŒ–ç»´æŠ¤å„ç½‘ç«™çš„è§£ææ¨¡æ¿ï¼Œæ”¯æŒåœ¨çº¿æµ‹è¯•è§„åˆ™æœ‰æ•ˆæ€§ã€‚
  - **é…ç½®ç®¡ç†**ï¼šåŠ¨æ€è°ƒæ•´æµè§ˆå™¨å¹¶å‘æ•°ã€è¶…æ—¶æ—¶é—´åŠå…¨å±€ä»£ç†è®¾ç½®ï¼Œæ”¯æŒä¸€é”®åˆå§‹åŒ–ç³»ç»Ÿé…ç½®åˆ°æ•°æ®åº“ã€‚
- **ç”¨æˆ·ç®¡ç†**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)ï¼Œä¿éšœç³»ç»Ÿå®‰å…¨ã€‚

## ğŸ“¦ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Python 3.10
- Node.js 22 
- RabbitMQ, MongoDB, Redis

### æœ¬åœ°å¼€å‘

1. **å…‹éš†ä»“åº“**
   ```bash
   git clone https://github.com/934050259/BrowserCluster.git
   cd browser-cluster
   ```

2. **ç¯å¢ƒé…ç½®**
   å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶å¹¶æ ¹æ®å®é™…ç¯å¢ƒä¿®æ”¹ï¼š
   ```bash
   cp .env.example .env
   # Windows (PowerShell)
   # copy .env.example .env
   ```
   
   ä¿®æ”¹ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“å’Œæ¶ˆæ¯é˜Ÿåˆ—è¿æ¥ä¿¡æ¯ï¼š
   ```ini
   MONGO_URI=mongodb://localhost:27017/
   REDIS_URL=redis://localhost:6379/0
   RABBITMQ_URL=amqp://guest:guest@localhost:5672/
   ```

3. **åˆå§‹åŒ–é…ç½®ä¸è´¦å·**
   è¿è¡Œåˆå§‹åŒ–è„šæœ¬ï¼Œå¯¼å…¥é»˜è®¤é…ç½®å¹¶åˆ›å»ºåˆå§‹ç®¡ç†å‘˜è´¦å·ï¼š
   ```bash
   # åˆå§‹åŒ–ç³»ç»Ÿé…ç½®
   python scripts/init_configs_db.py

   # åˆå§‹åŒ–é»˜è®¤ç®¡ç†å‘˜è´¦å· (è´¦å·: admin, å¯†ç : admin)
   python scripts/init_admin.py
   ```

4. **åç«¯è®¾ç½®**
   ```bash
   # å®‰è£…ä¾èµ–
   pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
   playwright install chromium

   # å¯åŠ¨ API æœåŠ¡
   uvicorn app.main:app --reload
   ```

5. **Worker å¯åŠ¨**
   Worker è´Ÿè´£ä»æ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶å¹¶æ‰§è¡Œå®é™…çš„ç½‘é¡µæŠ“å–ä»»åŠ¡ï¼š
   ```bash
   # å¯åŠ¨ Worker è¿›ç¨‹
   python scripts/start_worker.py
   ```
   æˆ–è€…åœ¨åå°ç®¡ç†ç•Œé¢-èŠ‚ç‚¹ç®¡ç†å†…æ·»åŠ å¹¶å¯åŠ¨worker

6. **å‰ç«¯è®¾ç½®**
   ```bash
   cd admin
   npm install
   npm run build  # æ„å»ºåç”±åç«¯ç»Ÿä¸€æ‰˜ç®¡ï¼Œæˆ–è¿è¡Œ npm run dev è¿›è¡Œå¼€å‘
   ```

7. **è®¿é—®ç³»ç»Ÿ**
   - ç®¡ç†åå°ï¼š`http://localhost:8000` (åç«¯æ‰˜ç®¡) æˆ– `http://localhost:5173` (Vite å¼€å‘æ¨¡å¼)
   - API æ–‡æ¡£ï¼š`http://localhost:8000/docs`

## ğŸ³ Docker éƒ¨ç½²

æœ¬é¡¹ç›®æ”¯æŒå¤šé˜¶æ®µæ„å»ºï¼Œé•œåƒå†…å·²é›†æˆå‰ç«¯é™æ€èµ„æºå’Œåç«¯æœåŠ¡ã€‚

### 1. æ„å»ºé•œåƒ

ç›´æ¥åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ„å»ºï¼Œæ— éœ€æå‰é…ç½® `.env`ï¼š

```powershell
docker build -t browser-cluster:latest .
```

### 2. è¿è¡Œå®¹å™¨

åœ¨å¯åŠ¨å®¹å™¨æ—¶é€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥é…ç½®å‚æ•°ã€‚å®¹å™¨å¯åŠ¨åä¼šè‡ªåŠ¨æ‰§è¡Œæ•°æ®åº“å’Œç³»ç»Ÿé…ç½®çš„åˆå§‹åŒ–ã€‚

#### å¯åŠ¨ API æœåŠ¡ (å«ç®¡ç†åå°)

å¦‚æœæ‚¨è¿½æ±‚æœ€å¿«å¯åŠ¨ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆä¸æŒ‚è½½å·ï¼‰ï¼š

```powershell
docker run -d `
  --name browser-cluster `
  -p 8000:8000 `
  -e MONGO_URI="mongodb://192.168.1.100:27017/" `
  -e REDIS_URL="redis://192.168.1.100:6379/0" `
  -e REDIS_CACHE_URL="redis://192.168.1.100:6379/1" `
  -e RABBITMQ_URL="amqp://guest:guest@192.168.1.100:5672/" `
  browser-cluster:latest
```

> **ğŸ’¡ å…³äº data å’Œ logs ç›®å½•ï¼š**
> - **å¦‚æœä¸è®¾ç½®æŒ‚è½½**ï¼šç³»ç»Ÿä¾ç„¶å¯ä»¥æ­£å¸¸è¿è¡Œã€‚ç¨‹åºä¼šè‡ªåŠ¨åœ¨å®¹å™¨å†…éƒ¨åˆ›å»º `data`ï¼ˆå­˜å‚¨é…ç½®å’Œè´¦å·ï¼‰å’Œ `logs`ï¼ˆå­˜å‚¨æ—¥å¿—ï¼‰æ–‡ä»¶å¤¹ã€‚
> - **ç¼ºç‚¹**ï¼šå½“æ‚¨åˆ é™¤å®¹å™¨å¹¶é‡æ–°åˆ›å»ºæ—¶ï¼Œåœ¨ Web ç•Œé¢ä¿®æ”¹çš„é…ç½®å’Œæ–°åˆ›å»ºçš„ç”¨æˆ·ä¼š**ä¸¢å¤±**ï¼ˆæ¢å¤åˆ°é»˜è®¤çŠ¶æ€ï¼‰ã€‚
> - **å»ºè®®**ï¼šå¦‚æœæ‚¨æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œï¼Œæˆ–è€…å¸Œæœ›ä¿ç•™é…ç½®ï¼Œå»ºè®®åŠ ä¸Šç›®å½•æŒ‚è½½ï¼š`-v ${PWD}/data:/app/data -v ${PWD}/logs:/app/logs`ã€‚

## âš™ï¸ é…ç½®è¯´æ˜

ä¸»è¦é…ç½®é¡¹ï¼ˆå¯é€šè¿‡ `.env` æˆ–ç¯å¢ƒå˜é‡è®¾ç½®ï¼‰ï¼š

### 1. åŸºç¡€ç¯å¢ƒé…ç½®

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- |
| `DEBUG` | `true` | æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼ï¼ˆè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼‰ |
| `HOST` | `0.0.0.0` | æœåŠ¡ç›‘å¬åœ°å€ |
| `PORT` | `8000` | æœåŠ¡ç›‘å¬ç«¯å£ |
| `SECRET_KEY` | `your-secret-key` | ç³»ç»Ÿå®‰å…¨å¯†é’¥ï¼ˆå»ºè®®ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä¿®æ”¹ï¼‰ |
| `MONGO_URI` | `mongodb://localhost:27017/` | MongoDB è¿æ¥åœ°å€ |
| `REDIS_URL` | `redis://localhost:6379/0` | Redis ä»»åŠ¡é˜Ÿåˆ—/çŠ¶æ€è¿æ¥åœ°å€ |
| `REDIS_CACHE_URL` | `redis://localhost:6379/1` | Redis ç»“æœç¼“å­˜è¿æ¥åœ°å€ |
| `RABBITMQ_URL` | `amqp://guest:guest@localhost:5672/` | RabbitMQ è¿æ¥åœ°å€ |

### 2. æµè§ˆå™¨ä¸æ‰§è¡Œé…ç½®

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- |
| `BROWSER_TYPE` | `chromium` | é»˜è®¤æµè§ˆå™¨ç±»å‹ (ç›®å‰ä»…æ”¯æŒ `chromium`) |
| `HEADLESS` | `true` | æ˜¯å¦å¼€å¯æ— å¤´æ¨¡å¼ |
| `STEALTH_MODE` | `true` | æ˜¯å¦å¼€å¯åçˆ¬è™«éšèº«æ¨¡å¼ |
| `DEFAULT_TIMEOUT` | `30000` | é»˜è®¤ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| `WORKER_CONCURRENCY` | `3` | å•ä¸ª Worker èŠ‚ç‚¹çš„å¹¶å‘ä»»åŠ¡æ•° |
| `NODE_ID` | `node-1` | èŠ‚ç‚¹å”¯ä¸€æ ‡è¯† |

### 3. OSS å­˜å‚¨é…ç½® (å¯é€‰)

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- |
| `OSS_ENABLED` | `false` | æ˜¯å¦å¯ç”¨ OSS å­˜å‚¨ï¼ˆå¼€å¯åå¯å°†ç»“æœå­˜è‡³äº‘ç«¯ï¼‰ |
| `OSS_ENDPOINT` | - | OSS è®¿é—®åŸŸåï¼ˆå¦‚ `oss-cn-hangzhou.aliyuncs.com`ï¼‰ |
| `OSS_ACCESS_KEY_ID` | - | OSS AccessKey ID |
| `OSS_ACCESS_KEY_SECRET` | - | OSS AccessKey Secret |
| `OSS_BUCKET_NAME` | - | OSS Bucket åç§° |

### 4. LLM å¤§æ¨¡å‹é…ç½® (å¯é€‰)

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- |
| `LLM_API_BASE` | `https://api.openai.com/v1` | å¤§æ¨¡å‹ API åŸºç¡€åœ°å€ |
| `LLM_API_KEY` | - | å¤§æ¨¡å‹ API å¯†é’¥ |
| `LLM_MODEL` | `gpt-3.5-turbo` | ä½¿ç”¨çš„æ¨¡å‹åç§° |

## ğŸ“ ä»»åŠ¡å‚æ•°è¯´æ˜

> **æäº¤æ ¼å¼è¯´æ˜**ï¼šæœ¬ç³»ç»Ÿæ‰€æœ‰é‡‡é›†æ¥å£ï¼ˆåŒæ­¥ã€å¼‚æ­¥ã€æ‰¹é‡ï¼‰å‡é‡‡ç”¨ **JSON** æ ¼å¼æäº¤ã€‚è¯·æ±‚å¤´å¿…é¡»åŒ…å« `Content-Type: application/json`ï¼Œå‚æ•°éœ€æ”¾ç½®åœ¨ HTTP è¯·æ±‚ä½“ï¼ˆBodyï¼‰ä¸­ã€‚
> 
> - **Python (requests)**: ä½¿ç”¨ `json={...}` ä¼ å‚ã€‚
> - **JavaScript (Axios)**: ç›´æ¥ä¼ å…¥å¯¹è±¡ `axios.post(url, {...})`ã€‚

### 1. æŠ“å–æ¥å£ (POST /api/v1/scrape/)

è¿™æ˜¯æœ€æ ¸å¿ƒçš„æ¥å£ï¼Œæ”¯æŒåŒæ­¥æŠ“å–å¹¶è¿”å›æ¸²æŸ“åçš„ç»“æœã€‚

#### **è¯·æ±‚ä½“ (JSON)**

| å‚æ•°å | ç±»å‹ | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| `url` | string | æ˜¯ | - | ç›®æ ‡ç½‘é¡µçš„å®Œæ•´ URL åœ°å€ |
| `params` | object | å¦ | `{}` | è¯¦ç»†çš„æŠ“å–é…ç½®å‚æ•°ï¼ˆè§ä¸‹è¡¨ï¼‰ |
| `cache` | object | å¦ | `{"enabled": true, "ttl": 3600}` | ç¼“å­˜é…ç½®ï¼ˆè§ä¸‹è¡¨ï¼‰ |
| `priority` | int | å¦ | `1` | ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆå¤„ç† |

#### **cache é…ç½®è¯¦è§£**

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `enabled` | bool | `true` | æ˜¯å¦å¯ç”¨ç¼“å­˜ |
| `ttl` | int | `3600` | ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 1 å°æ—¶ |

#### **params é…ç½®è¯¦è§£**

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `wait_for` | string | `networkidle` | ç­‰å¾…ç­–ç•¥ï¼š`networkidle` (ç½‘ç»œç©ºé—²), `load` (åŠ è½½å®Œæˆ), `domcontentloaded` |
| `wait_time` | int | `3000` | é¡µé¢åŠ è½½å®Œæˆåçš„é¢å¤–ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œç”¨äºå¤„ç†å¼‚æ­¥æ¸²æŸ“ |
| `timeout` | int | `30000` | æŠ“å–æ€»è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| `selector` | string | `null` | ç­‰å¾…ç‰¹å®šçš„ CSS é€‰æ‹©å™¨å‡ºç°åå†è¿”å›ç»“æœ |
| `screenshot` | bool | `false` | æ˜¯å¦ç”Ÿæˆé¡µé¢æˆªå›¾ |
| `is_fullscreen` | bool | `false` | æ˜¯å¦æˆªå–å…¨å±ï¼ˆä»…åœ¨ `screenshot` ä¸º true æ—¶ç”Ÿæ•ˆï¼‰ |
| `block_images` | bool | `false` | æ˜¯å¦æ‹¦æˆªå›¾ç‰‡èµ„æºåŠ è½½ï¼Œå¯æ˜¾è‘—æå‡é€Ÿåº¦ |
| `block_media` | bool | `false` | æ˜¯å¦æ‹¦æˆªè§†é¢‘ã€éŸ³é¢‘ã€å­—ä½“ã€CSS ç­‰åª’ä½“å’Œèµ„æº |
| `user_agent` | string | `null` | è‡ªå®šä¹‰æµè§ˆå™¨ User-Agent |
| `stealth` | bool | `true` | æ˜¯å¦å¯ç”¨åæ£€æµ‹æ’ä»¶ï¼Œæ¨¡æ‹ŸçœŸå®äººç±»è¡Œä¸º |
| `intercept_apis` | list | `[]` | è¦æ‹¦æˆªå¹¶æå–æ•°æ®çš„æ¥å£ URL æ¨¡å¼åˆ—è¡¨ï¼ˆæ”¯æŒæ­£åˆ™ï¼‰ |
| `intercept_continue` | bool | `false` | æ‹¦æˆªæ¥å£åæ˜¯å¦ç»§ç»­è¯·æ±‚ï¼ˆé»˜è®¤ False ä¸ºä¸­æ­¢è¯·æ±‚ï¼‰ |
| `viewport` | object | `{"width": 1920, "height": 1080}` | æ¨¡æ‹Ÿçš„æµè§ˆå™¨è§†å£å¤§å° |
| `storage_type` | string | `mongo` | å­˜å‚¨ä½ç½®ï¼š`mongo` (é»˜è®¤) æˆ– `oss` (éœ€é…ç½®å‡­æ®) |
| `save_html` | bool | `true` | æ˜¯å¦ä¿å­˜ HTML æºç  |
| `engine` | string | `playwright` | æµè§ˆå™¨å¼•æ“ï¼š`playwright` æˆ– `drissionpage` |
| `proxy` | object | `null` | ä»£ç†æœåŠ¡å™¨é…ç½®ï¼Œæ ¼å¼ï¼š`{"server": "...", "username": "...", "password": "..."}` |
| `cookies` | string/object/list | `null` | æ³¨å…¥ Cookieã€‚æ”¯æŒå­—ç¬¦ä¸² (`name=val;`), JSON å¯¹è±¡ (`{name: val}`) æˆ– JSON æ•°ç»„ (`[{name, value, ...}]`)ã€‚è‡ªåŠ¨é€‚é…ä¸»åŸŸåã€‚ |
| `parser` | string | `null` | è§£ææœåŠ¡ç±»å‹ï¼š`gne` (é€šç”¨æ–°é—»è§£æ), `xpath` (è‡ªå®šä¹‰è§„åˆ™), `llm` (å¤§æ¨¡å‹è§£æ) |
| `parser_config` | object | `null` | è§£æé…ç½®ã€‚<br>â€¢ **gne**: å¯é€‰ `{"mode": "detail"}` (è¯¦æƒ…æ¨¡å¼ï¼Œé»˜è®¤) æˆ– `{"mode": "list"}` (åˆ—è¡¨æ¨¡å¼)ã€‚<br>â€¢ **llm**: å¿…é€‰ `{"fields": ["title", "price"]}` æŒ‡å®šæå–å­—æ®µã€‚ |

#### **è¯·æ±‚ç¤ºä¾‹**

```json
{
  "url": "https://example.com",
  "params": {
    "wait_for": "networkidle",
    "screenshot": true,
    "block_images": true,
    "stealth": true,
    "cookies": "name=value; session=123",
    "intercept_apis": ["/api/v1/data/.*"],
    "proxy": {
      "server": "http://proxy.example.com:8080"
    }
  },
  "cache": {
    "enabled": true,
    "ttl": 3600
  }
}
```

### 2. å¼‚æ­¥æŠ“å– (POST /api/v1/scrape/async)

å¼‚æ­¥æäº¤æŠ“å–ä»»åŠ¡ï¼Œä¸ç­‰å¾…æ‰§è¡Œç»“æœï¼Œç«‹å³è¿”å›ä»»åŠ¡ IDã€‚é€‚ç”¨äºè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡æˆ–ä¸éœ€è¦å³æ—¶å“åº”çš„åœºæ™¯ã€‚

#### **è¯·æ±‚ä½“**
ä¸åŒæ­¥æŠ“å–æ¥å£ (`/api/v1/scrape/`) å®Œå…¨ä¸€è‡´ã€‚

#### **å“åº”ç¤ºä¾‹**
```json
{
  "task_id": "65b2...",
  "url": "https://example.com",
  "status": "pending",
  "created_at": "2024-01-25T10:00:00"
}
```

### 3. æ‰¹é‡æŠ“å– (POST /api/v1/scrape/batch)

æ”¯æŒä¸€æ¬¡æ€§æäº¤å¤šä¸ªæŠ“å–ä»»åŠ¡ã€‚æ‰¹é‡æ¥å£ç›®å‰ä»…æ”¯æŒå¼‚æ­¥æ¨¡å¼ï¼Œä¸ç›´æ¥è¿”å›æŠ“å–ç»“æœã€‚

#### **è¯·æ±‚ä½“**
```json
{
  "tasks": [
    {
      "url": "https://example.com/1",
      "params": { ... }
    },
    {
      "url": "https://example.com/2",
      "priority": 2
    }
  ]
}
```

### 4. ä»»åŠ¡ç®¡ç†æ¥å£

ç”¨äºæŸ¥è¯¢å¼‚æ­¥/æ‰¹é‡ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å’Œç»“æœã€‚

#### 4.1 è·å–ä»»åŠ¡è¯¦æƒ…

`GET /api/v1/tasks/{task_id}`

**æŸ¥è¯¢å‚æ•° (Query Parameters):**

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `include_html` | `boolean` | `true` | æ˜¯å¦åœ¨ç»“æœä¸­åŒ…å«å®Œæ•´çš„ HTML æºç ã€‚æ•°æ®é‡å¤§æ—¶å»ºè®®è®¾ç½®ä¸º `false`ã€‚ |
| `include_screenshot` | `boolean` | `true` | æ˜¯å¦åœ¨ç»“æœä¸­åŒ…å«æˆªå›¾ Base64 æ•°æ®ã€‚æ•°æ®é‡å¤§æ—¶å»ºè®®è®¾ç½®ä¸º `false`ã€‚ |

#### 4.2 æ¥å£åˆ—è¡¨

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
| :--- | :--- | :--- |
| `/api/v1/tasks/{task_id}` | GET | è·å–å•ä¸ªä»»åŠ¡è¯¦æƒ…ï¼ˆåŒ…å«æŠ“å–ç»“æœï¼‰ |
| `/api/v1/tasks` | GET | åˆ†é¡µè·å–ä»»åŠ¡åˆ—è¡¨ï¼Œæ”¯æŒçŠ¶æ€/URLæœç´¢ |
| `/api/v1/tasks/{task_id}/retry` | POST | é‡è¯•å¤±è´¥çš„ä»»åŠ¡ |
| `/api/v1/tasks/{task_id}` | DELETE | åˆ é™¤æŒ‡å®šä»»åŠ¡ |
| `/api/v1/tasks/batch` | DELETE | æ‰¹é‡åˆ é™¤ä»»åŠ¡ |

### 5. å®šæ—¶ä»»åŠ¡æ¥å£

ç”¨äºç®¡ç†è‡ªåŠ¨åŒ–è°ƒåº¦çš„æŠ“å–ä»»åŠ¡ã€‚

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
| :--- | :--- | :--- |
| `/api/v1/schedules` | GET | åˆ†é¡µè·å–å®šæ—¶ä»»åŠ¡åˆ—è¡¨ |
| `/api/v1/schedules` | POST | åˆ›å»ºæ–°çš„å®šæ—¶ä»»åŠ¡ |
| `/api/v1/schedules/{id}` | GET | è·å–å®šæ—¶ä»»åŠ¡è¯¦æƒ… |
| `/api/v1/schedules/{id}` | PUT | æ›´æ–°å®šæ—¶ä»»åŠ¡é…ç½® |
| `/api/v1/schedules/{id}` | DELETE | åˆ é™¤å®šæ—¶ä»»åŠ¡ |
| `/api/v1/schedules/{id}/toggle` | POST | åˆ‡æ¢ä»»åŠ¡çŠ¶æ€ï¼ˆæ¿€æ´»/æš‚åœï¼‰ |
| `/api/v1/schedules/{id}/run` | POST | ç«‹å³æ‰‹åŠ¨è§¦å‘æ‰§è¡Œä¸€æ¬¡ |

### 6. è§£æè§„åˆ™æ¥å£

ç”¨äºç»´æŠ¤ç»“æ„åŒ–æå–è§„åˆ™ã€‚

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
| :--- | :--- | :--- |
| `/api/v1/rules` | GET | è·å–è§£æè§„åˆ™åˆ—è¡¨ |
| `/api/v1/rules` | POST | åˆ›å»ºæ–°è§£æè§„åˆ™ |
| `/api/v1/rules/{rule_id}` | PUT | æ›´æ–°æŒ‡å®šè§„åˆ™ |
| `/api/v1/rules/{rule_id}` | DELETE | åˆ é™¤æŒ‡å®šè§„åˆ™ |

## ğŸ“„ License

MIT
